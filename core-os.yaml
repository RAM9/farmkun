variant: fcos
version: 1.5.0
passwd:
  users:
    - name: core
      password_hash: $1$82024$51fV6RLyDo3oFsfkc3H7S/
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFBQm/e9Ej4PuQuo/M2IV0/IxGAOE83oMnBCwBn2WAaP
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDGyraMnjnSZiPrRZKkRixfA9qatS8EA5AD1mhRP7bRp8d2ix98lp2NvJ43hC4aEmH/PWIfPPAMVPR0URMydS65xJHvQwl/Z6ULJuYxp6Lwlfec3KfrPOy4QmKUc+hfJC3gu5U7HW6iU7s91gPGz4IO1p/XPmi0GLfWBAbqLhcvteIykQ4zlFHdjdHy07gc3IICoSvQhOgBjhAMwtkr0tWJeXIbdk70f/bOha4tr1GM493IBrtoFkK95Na7HnAw8Jj7TAIh8LqB8FWwU8zkXl0wUHN3jz5Vg6IWdINfY7OSNwmnSjWH5FHPYS85uSrodLiAIusAe2ulFtO61wTGjqVylgspVXLklF7Kpyoyf5AtoxlVMPFN0uiZqhuJ3JaBn0e0gbQvGwPQKo2ZV+dmssIvatKg3MDDURJfT/k0gIViomyzD/Ol8RIy6uCTqHV4fa5MvgCGj3Yy7oN3vNhqdbqxsfHBh3E/x+rXnNHSn27OUhVSBLe3INgPnKghnTSRyHNu7b5jwCqzWan0DY7TkGzv/JL2onFpQWFKoziQ89h5yWcOD8OOMmWJZ5r4rp3qGBkyB8e3CNxDNRobhDVU8ZG7AKz5avLAgL43pNbnYzDrTDtP/Q9EVKrLKFK0pkaNtKmRx8Dr1oXlpODWBoOHgqnV92y0au7SVzN05/RFUcyp6Q==
      groups:
        - wheel
        - sudo
systemd:
  units:
    - name: install-rancher2-tar.service
      enabled: true
      contents: |
        [Unit]
        Description=Install Rancher2 Via Tar
        Wants=network-online.target
        After=network-online.target
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/sh /etc/rancher/install.sh
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/bin/bash /etc/rancher/post-install.bash

        [Install]
        WantedBy=multi-user.target
    # Installing vim as a layered package with rpm-ostree
    - name: rpm-ostree-install-vim.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer vim with rpm-ostree
        Wants=network-online.target
        After=install-rancher2-tar.service
        # We run before `zincati.service` to avoid conflicting rpm-ostree
        # transactions.
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/rpm-ostree install -y --allow-inactive vim
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/bin/systemctl --no-block reboot

        [Install]
        WantedBy=multi-user.target
storage:
  files:
    - path: /etc/rancher/post-install.bash
      overwrite: true
      contents: 
        inline: |
          #!/bin/env bash
          role=$(/bin/hostname | /bin/awk '{split($1,a, ".")};{}{print substr(a[1],length("farm")+1,3)};')
          if [ "$role" == "bot" ]; then
            /bin/echo ">>>>Found farmbot - setting rke2-agent"
            /bin/systemctl enable rke2-agent.service
            /bin/systemctl start --no-block --now rke2-server.service
          elif [ "$role" == "kun" ]; then
            /bin/echo ">>>>Found farmbot - setting rke2-server"
            /bin/systemctl enable rke2-server.service
            /bin/systemctl start --no-block --now rke2-server.service

          else
            /bin/echo ">>>XXXX>>> Unknown role:($role) <<<XXX<<<"
          fi;
      mode: 0744

    - path: /etc/rancher/install.sh
      overwrite: true
      contents:
        source: https://get.rke2.io
    # Set vim as default editor
    # We use `zz-` as prefix to make sure this is processed last in order to
    # override any previously set defaults.
    - path: /etc/profile.d/zzz-default-editor.sh
      overwrite: true
      contents:
        inline: |
          export EDITOR=vim

